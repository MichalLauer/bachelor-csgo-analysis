---
title: "Analýza esportových dat"
author: "Michal Lauer"
date: "Bakalářská práce"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    df_print: paged
  theme: paper
  highlight: pygments
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      fig.align = "center", fig.width = 9)
set.seed(12345)
count_na <- \(tbl){
  tbl %>%
    summarise_all(is.na) %>%
    summarise_all(sum) %>%
    pivot_longer(cols = everything(),
                 names_to = "column_name",
                 values_to = "count_of_NAs") %>%
    mutate(percent_ratio = count_of_NAs/nrow(tbl)*100) %>%
    filter(count_of_NAs != 0)
}

```
# Úvod
Tento report se zabývá deskriptivní a inferenční analýzou dat. Dataset, který se dá získat na portálu
[kaggle.com](https://www.kaggle.com/mateusdmachado/csgo-professional-matches), obsahuje 4 csv soubory

- *players.csv* -> obsahuje statistiky hráčů v zápasech. Dataset je použit pro **deskriptivní analýzu**
- *economy.csv* -> zde se nachází stav financí každého teamu v jednotlivém kole každého zápasu. Toto lze využít pro **inferenční analýzu**
- *picks.csv* -> v tomto souboru jsou vybrané mapy každého teamu v jejich zápasech. Tento soubor lze použít k **inferenční analýze** map, které si team nejspíše vybere proti oponentu
- *results.csv* -> díky tomuto souboru, který obsahuje výsledky zápasu, můžeme simulovat utkání jednotlivých teamů a určit, který team má větší šanci vyhrát. Toto je část **inferenční analýzy**


Každý soubor má vlastní sekci, která se skládá z několika částí

1) *porozumnění datasetu*
2) *nahrání, očištění a transformace dat*
3) *daná analýza*
4) *závěr*

# Statistiky hráčů
Díky souboru *players.csv* můžeme získat statistiky hráčů. Ty lze dále použít k popisu hráču,
statistik dle různých kategorií, porovnání hráčů či nalezení nejlepších/nejhorších jedinců.

## Porozumnění datasetu
Dataset obsahuje záznamy o zápasech a hráčích. Každý záznam se rovná právě jednomu hráči. Zápasy můžeme spojit díky proměnné *match_id*. Každý hráč je dále identifikován svým id *(player_id)* a jménem *(player_name)*. Dále se nám hodí team, za který hráč hraje *(team)*, oponent v daném zápase *(opponent)*, jménu turnaje *(event_name)* a země, ze které daný hráč je *(country)*. O zápase známejeho typ *(best_of)* a názvy map *(map_1, map_2, map_3)*.
  Jednotlivé statistiky hráče obsahují počet zabití v celém zápase *(kills)*, počet asistencí v zápase *(assists)*, počet smrtí v zápase *(deaths)* a počet tzn. headshotů v zápase - usmrcení nepřátelského hráče do hlavy *(hs)*. Pokud zápas obsahoval více map, jsou dle toho statistiky dále rozděleny.

## Nahrání dat
Data narhajeme, vybere pouze sloupce, které se nám k analýze hodí a nastavíme jim správné datové typy.
```{r players-load}
library(tidyverse)
players <- read_csv("data/players.csv",
                    col_select = c("date", "player_name", "team", "opponent", "country",
                                   "player_id", "match_id",
                                   "event_name", "best_of", "map_1", "map_2", "map_3",
                                   "kills", "assists", "deaths", "hs",
                                   "m1_kills", "m1_assists", "m1_deaths","m1_hs",
                                   "m2_kills", "m2_assists", "m2_deaths","m2_hs",
                                   "m3_kills", "m3_assists", "m3_deaths","m3_hs"),
                    col_types = list(
                      date = col_date(),
                      player_name = col_factor(),
                      team = col_factor(),
                      opponent = col_factor(),
                      country = col_factor(),
                      player_id = col_factor(),
                      match_id = col_factor(),
                      event_name = col_factor(),
                      best_of = col_factor(levels = c("1","2","3","5"),
                                           ordered = T),
                      map_1 = col_factor(),
                      map_2 = col_factor(),
                      map_3 = col_factor()
                    )
) %>%
  mutate(
    across(.cols = everything(), .fns = na_if, y = "")
    )

attr(players, "spec") <- NULL

players %>% 
  sample_n(10) %>%
  str

```

## Očištění dat
Data je načase očistit. Prve zjistíme, kde se nachází NA hodnoty.
```{r players-null-analysis}
count_na(players)
```
NA, neboly chybějící hodnoty v prvním sloupci jsou problém. Pokud nemáme jméno hráče, data nám moc užitečná nebudou - záznam proto smažeme. Zbývající proměnné problém nejsou. Ne každý zápas měl druhou či třetí mapu. Pokud třetí mapu neměl, data z daných map nebudou existovat.
```{r player-cleanup}
players <- players  %>%
  filter(!is.na(player_name))
```

## Transformace dat
Data jsou již očištěna a zkontrolována. Nyní přídamě dvě proměnné - rok a měsíc daného zápasu. Tvorba je velmi jednoduchá, jelikož sloupce jdou lehce odvodit z proměnné *date*. Dále přidáme kontinent, který lehce získáme z package *countrycode*. V případě, že je kontinent *NA*, záznam odstraníme. Jedná se pouze o 15 záznamu, což analýzu nijak zvláštně neovlivní.
```{r players-transform}
library(countrycode)
players <- players %>%
  filter(country != "Other") %>%
  mutate(year = format(date, "%Y"),
         month = format(date, "%B"),
         player_name = fct_relevel(player_name, sort),
         continent = countrycode(country, "country.name", "continent")
         )

players %>%
  select(date, player_name, month, year, continent) %>%
  sample_n(10)
```

## Popis dat
... DOPSAT

### Statistiky dle země
... DOPSAT, 
```{r players-avg-matches-per-player}
library(ggplot2)
players.cnt_per_cont_year <- players %>%
  group_by(continent, year) %>%
  summarise(player_count = n_distinct(player_id),
            match_count = n_distinct(match_id),
            ratio = round(match_count*10 / player_count, 2)) %>%
  filter(year != 2015, year != 2020)

ggplot(players.cnt_per_cont_year, aes(x = continent, y = ratio,
                                      fill = year)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = ratio, hjust = -0.2), angle = 90, 
            position = position_dodge(width = 0.9)) +
  theme_bw() + 
  scale_y_continuous(limits = c(0, 60),
                     expand = c(0,0)) +
  ggtitle("Average number of matches per player per year") +
  ylab("Ratio of matches vs. players") + 
  xlab("Continent")
```
test....
```{r players-match-player-count}
players.cnt_per_cont_year_longer <- players.cnt_per_cont_year %>%
  select(-ratio) %>%
  pivot_longer(-c(continent, year), names_to = "stat", values_to = "value")



ggplot(players.cnt_per_cont_year_longer, aes(x = continent, y = value,
                                             fill = year)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(rows = vars(stat), scales = "free") + 
  scale_y_continuous(expand = expansion(mult = c(0, .4))) +
  geom_text(aes(label = value, hjust = -0.2),
            angle = 90,
            position = position_dodge(width = 0.9)) +
  theme_bw() +
  ggtitle("Number of players or matches per year per continent") +
  xlab("Continent") +
  theme(axis.title.y = element_blank(),
        legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 1))
```
test....
```{r players-match-player-growth}
players.gth_per_cont_year_longer <- players.cnt_per_cont_year %>%
  select(-ratio) %>%
  filter(year != 2015) %>%
  mutate(player_growth = round(
    (player_count - lag(player_count))/lag(player_count) * 100,
    2),
    match_growth = round(
    (match_count - lag(match_count))/lag(match_count) * 100,
    2)
  ) %>%
  select(!ends_with("_count")) %>%
  pivot_longer(-c(continent, year), names_to = "stat", values_to = "value") %>%
  mutate(value = ifelse(is.na(value), 100, value))



ggplot(players.gth_per_cont_year_longer, aes(x = year, y = value,
                                             color = continent, group = continent)) +
  geom_point() +
  geom_line() +
  facet_grid(cols = vars(stat), scales = "free") +
  theme_bw() +
  ggtitle("Number of players or matches per year per continent") +
  xlab("Continent") +
  theme(axis.title.y = element_blank(),
        legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 1))
```






