---
title: "Analýza dat pro Bakalářskou práci"
author: "Michal Lauer"
date: '2022-04-10'
output:
  html_document:
    css: style.css
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    df_print: paged
    theme: cosmo
    highlight: haddock
editor_options: 
  chunk_output_type: console
---
# Funkce a globální nastavení

## Nastavení
```{r global-options, message=F}
knitr::opts_chunk$set(message = F)
options(OutDec = ",")
```

## Knihovny
```{r libraries}
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(runner)
library(ggplot2)
library(GGally)
library(kableExtra)
library(knitr)
library(caret)
library(broom)
library(xtable)

theme_set(theme_minimal() +
            theme(
              plot.caption = element_text(face = "italic")
            ))
```

## Vygenerování pomocních grafů
Pro bakalářskou práci jsou potřeba další podpůrné grafy. Ty jsou
generovány na stránce [grafy](grafy.html)
```{r grafy.Rmd, include=F}
rmarkdown::render("grafy.Rmd",
                   quiet = T)
```

## globální proměnná maps
Mapy, pro které se počítají statistiky
```{r maps}
maps <- c(
  "Dust2", "Inferno", "Vertigo", "Overpass", "Nuke", "Mirage",
  "Train", "Cache", "Cobblestone"
)
```

## Ukládání pro bakalářskou ráci
```{r bc, file="R/_GLOBAL.R"}
```

## funkce clear_player_map
Funkce slouží k extrakci statistik hráčů pro dané pořadové číslo
mapy v zápase
```{r clear_player_map}
#' Dataset contains statistics for all maps in one row.
#' Function recieves players tibble and a number of a map. The output
#' is a tibble that splits the statistics and each row contains 
#' stats for a given map, no matter the number.
#'
#' @param tbl Tibble of players
#' @param map Number of a map. Can be one, two, or three
#'
#' @return Tibble with statistics for a given map
clear_player_map <- function(tbl, map) {
  m_ <- sprintf("m%i_", map)
  tbl |>
    select(match_id,
      player_id,
      team,
      # Select statistics regarding specified map
      map = sprintf("map_%i", map),
      matches(sprintf("^m%i_", map))
    ) |>
    # matches only aggregated statistics for specified map
    # e.g. excludes m1_kills_ct, m1_kills_t and keeps only m1_kills
    select(!matches("_c?t$")) |>
    drop_na(map) |>
    # Unify names, e.g. m1_kills -> kills
    rename_with(
      .cols = starts_with(m_),
      .fn = ~ str_remove_all(.x, m_)
    ) |>
    # remove columns that are only calculated from other columns
    # or are troublesome because of the website history tracking
    select(-c(kddiff, flash_assists, kast, adr)) |>
    # make HS relative and not absolute
    mutate(hs = ifelse(kills == 0, 0, hs / kills))
}
```

## funkce clear_results_team
Funkce pro získání $i$-tého týmu z tabulky výsledků
```{r clear_results_team}
#' The source data frame contains team_1 and team_2 in results.
#' This method returns a tibble with data for team_1 or team_2
#' with the correct match results
#'
#' @param tbl Tibble with results
#' @param i Team number, can be either one or two
#'
#' @return Tibble with results for i-th team
clear_results_team <- function(tbl, i) {
  tbl |>
    select(
      date,
      match_id,
      team = matches(sprintf("team_%i", i)),
      map,
      map_winner,
      starting_ct,
      team_rank = matches(sprintf("rank_%i", i))
    ) |>
    filter(map %in% maps) |>
    mutate(
      map_winner = as.numeric(map_winner == i),
      starting_ct = as.numeric(starting_ct == i)
    )
}
```

## funkce geom_mean
Funkce pro vypočtení geometrického průměru dle https://en.wikipedia.org/wiki/Geometric_mean
```{r geom_mean}
#' Compute geometric mean. Helps with statistics such as HS or Rating
#' Funstion uses log transformation because the ongoing calculations
#' were small and R couldn't handle them.
#' 
#' @param x Number vector
#'
#' @return Geometric mean
geom_mean <- function(x) {
  exp(sum(log(x)) / length(x))
}
```

## funkce save_bc_code
Pro uložení mezivýpočtů a textu pro účely bakalářské práce
```{r save_bc_code, file="R/save_bc_code.R"}
```

## funkce save_bc_picture
Pro uložení obrázků z balíčku ggplot2
```{r save_bc_picture, file="R/save_bc_picture.R"}
```

# Cíl analýzy
Cílem analýzy je vytvořit logistické regresní modely, které
předpovíjí výsledky zápasů. Jako prediktory budou sloužit statistiky
kills, assists, deaths, hs, fkdiff, rating, team_rank a 
run_mean_3_months. V průzkumové analýze jsou nejprve zobrazeny 
kvalitativní a kvantitativní proměnné. Následně jsou vytvořené
modely přes různé kategorie.

# Nahrání dat

## economy.csv
Jelikož se predikce soustředí na předpovídání výsledku ještě než zápas začal,
informace o vývoji ekonomiky jednotlivého teamu v zápasu není potřeba a soubor
*economy.csv* se nevyužije.

## picks.csv
Dataset *picks.csv* obrahuje pořadí, v jakých týmy proti sobě banovali či vybírali
mapy. Tato informace by byla podstatná v případě simulace zápasu
mezi dvěma tými. Jelikož se ovšem jedná pouze o předpověd výsledku
zápasů, dataset není použít.

## players.csv
Soubor *players.csv* obsahuje detailní statistiky hráčů v jednotlivých zápasech.
Jeden řádek obsahuje statistiky pro jeden zápas, ale pro všechny mapy
(resp. jednu, dvě, nebo tři).
```{r players.raw}
players.raw <- read_csv("data/players.csv", show_col_types = F)

# Get only matches where we have data for all 10 players
players.raw <- players.raw |>
  group_by(match_id) |> 
  filter(n() == 10)

players.raw |>
  slice_sample(n = 10) |>
  print()
```

Pro potřeby logistické statistiky za zápas a mapy musí sjednotit.
Model nebude brát v potaz, zda se mapa hraje jako první, druhá, či
třetí. Proto se data transformují do formátu, kde jeden řádek popisuje
statistiky jednoho hráče na jedné mapě. Reprezentace statistik
jednoho hráče v jednom zápase je tedy rozdělena na více řádků. Z 
datasetu se následně vyloučí nepotřebné mapy a použijí se pouze
zápasy, ve kterých máme statistiky pro všech 10 hráčů.
```{r players}
players <- clear_player_map(players.raw, 1) |>
  rbind(clear_player_map(players.raw, 2)) |>
  rbind(clear_player_map(players.raw, 3)) |>
  filter(map %in% maps) |>
  drop_na() |> 
  group_by(match_id) |>
  # Delete matches which do not contain 10 players in total
  # A propper match_id can have 10 (Bo1), 20 (Bo2), or 30 (Bo3) rows
  filter(n() %% 10 == 0) |>
  ungroup()
```

Pro interpretaci dat použijeme první řádek z transformovaného
datasetu
```{r players-interpretation}
set.seed(12345)
r <- players |> 
  slice_sample(n = 6)
save_bc_code(
  .tibble = r,
  .file = "players_csv_transformovano.tex",
  .cap = "Záznam z transformovaného datového souboru players.csv",
  .lab = "players_csv_transformovano",
  .scale = 0.8)
r
```


- **match_id** - Identifikátor zápasu
- **player_id** - Identifikátor hráče
- **team** - Jméno týmu, za které hráč v zápase hrál
- **map** - Mapa, na které se zápas odehrál
- **kills** - počet zabití daného hráče na mapě
- **assists** - počet asistencí daného hráče na mapě
  - hráč nepřítele nezabil, ale udělil mu velké poškození
- **deaths** - počet smrtí daného hráče na mapě
- **hs** - procento, kolik zabití bylo tzn. headshotem
  - v případě že hráč zabije nepřítele střelou do hlavy
- **fkdiff** - rozdíl mezi prvním zabitím a první smrtí
  - pokud hráč jako první zabil nepřítele, pričte se jedna. Pokud
  hráč jako první umřel, odečte se jedna
- **rating** - rating hráče v daném zápasu
  - rating je vypočítán stránkou [hltv.org](https://www.hltv.org/)

## results.csv
Poslední datový soubor *results.csv* obsahuje tu nejdůležitější
proměnou, a to výsledek daného zápasu. Z datasetu je nutné
vyloučit chybný záznam, kde tým hrál sám proti sobě. Nejspíše se stala
chyba při exportu dat, jelikož zápas je na webu zadán ve správném
formátu.
```{r results.raw}
results.raw <- read_csv("data/results.csv",
  show_col_types = F,
  col_select = c(date, team_1, team_2,
    map = "_map", map_winner,
    starting_ct, rank_1, rank_2, match_id
  )
) |>
  # Incorrect data when team played against itself
  filter(match_id != 2314674)
```

Podobně jako se souborem *players.csv*, i zde každý řádek reprezentuje
více statistik. Zde to je výhra, resp. prohra, daného teamu. Je nutné
proto dataset transformovat do formátu, kde každý zápas bude mít dva 
řádky. Jeden pro výherní tým (**map_winner = 1**) a druhý pro
tým co prohrál (**map_winner = 0**). Jelikož team mohl mít
v zápase jiný rank, výsledný rank, je spočítán průměrný rank týmu
za poslední 3 měsíce.
```{r results, cache=TRUE}
results <- clear_results_team(results.raw, 1) |>
  rbind(clear_results_team(results.raw, 2)) |> 
  group_by(team) |> 
  arrange(date, .by_group = T)

# Takes approx. 3,5 mins
results <- results |>
  mutate(run_mean_3_months = runner(
    x = results,
    k = "3 months",
    f = function(tbl) {
      mean(tbl$team_rank)
    },
    idx = "date"
  )) |>  
  ungroup()

set.seed(9574)
r <- results |> 
  slice_sample(n = 6)
save_bc_code(
  .tibble = r,
  .file = "results_csv_transformovano.tex",
  .cap = "Příklad záznamu z transformovaného datového souboru results.csv",
  .lab = "results_csv_transformovano",
  .scale = 0.8
)
r
```

Interpretace je následující:

- **date** - Datum zápasu
- **match_id** - Identifikáto= zápasu
- **team** - Jméno týmu
- **map** - Hraná mapa
- **map_winner** - Ukazuje, zda tým zápas vyhrál
- **starting_ct** - Ukazuje, zda tým začal za CT (Counter-Terrorists) 
nebo T (Terrorists)
- **team_rank** - Rank týmu v dobu, kdy se zápas odehrál
- **run_mean_3_months** - Průměrný rank týmu za poslední 3 měsíce

# Průzkumová analýza dat
Explorační analýza dat slouží ke grafickému zobrazení datasetu.
```{r data}
data <- players |> 
  inner_join(results,
            by = c("match_id", "map", "team"))

set.seed(7845)
r <- data |> 
  slice_sample(n = 6)
save_bc_code(
  .tibble = r,
  .file = "data_transformovano.tex",
  .cap = "Datový soubor pro logistické modely",
  .lab = "data_transformovano",
  .scale = 0.52)
r
```

## Kvantitativní proměnné
```{r quantitative}
g <- data |> 
  select(kills, assists, deaths, hs, fkdiff, rating,
         run_mean_3_months ) |> 
  ggcorr(hjust = 0.8, size = 4, label = T) +
  labs(
    title = "Korelační matice kvantitativních prediktorů",
    caption = "Spojení souboru players.csv a results.csv"
  )

save_bc_picture(.graph = g,
                .file = "prediktory_corr_matice.png")
g
```

## Histogram proměnných
```{r histogram_maps}
bin_count <- round(1 + 3.3*log10(nrow(data)/6))
g <- data |>
  pivot_longer(
    cols = c(kills, assists, deaths, hs, fkdiff, rating),
    names_to = "stats",
    values_to = "vals"
  ) |> 
  select(stats, vals) |>
  mutate(bins = 1 + 3.3*log10(n()/6),
         bins = 1) |> 
  ggplot(aes(x = vals, fill = stats)) +
  facet_wrap(vars(stats), ncol = 2, scales = "free") +
  geom_histogram(bins = bin_count, show.legend = F) +
  scale_y_continuous(labels = scales::number) +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_rect(fill = "grey")
  ) +
  labs(
    title = "Rozdělení kvantitativních statistik",
    subtitle = "Osa Y je přizpůsobená každé statistice",
    y = "Absolutní počet",
    caption = "Spojení souboru players.csv a results.csv"
  )

save_bc_picture(.graph = g,
                .file = "histogram_prediktoru.png")
g
```

## Winrate za CT
```{r winrate}
g <- data |>
  group_by(team, map) |> 
  filter(map_winner == 1, team %in% c("Astralis", "eSuba")) |> 
  summarise(ct_won = mean(starting_ct)) |> 
  ggplot(aes(x = map, y = ct_won, fill = map)) +
  facet_wrap(vars(team), ncol = 1, scales = "free_x") +
  geom_col(show.legend = F, color = "black") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  theme(
    panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill = "grey", color = "black")
  ) +
  labs(
    title = "Procento vyhraných zápasu, pokud tým začal\nna mapě za Counter-Terroristy",
    subtitle = "Pouze pro týmy Astralis a eSuba",
    x = "Mapa",
    y = "Procento vyhraných zápasů",
    caption = "Spojení souboru players.csv a results.csv",
    fill = "Tým"
  )
  
save_bc_picture(.graph = g,
                .file = "sloupce_podle_strany.png")
g
```

# Model pro hráče
```{r get_model_for_player, options}
get_player_model <- function(.data,
                             .y = "map_winner",
                             .x = "kills + assists + deaths + hs + fkdiff + starting_ct"
) {
  
  .formula = as.formula(sprintf("%s ~ %s",
                                .y,
                                .x))
  
  glm(formula = .formula,
      data = .data,
      family = binomial)
}

get_matrix_for_player_model <- function(.model, .test) {
  confusionMatrix(
    data = predict(object = .model,
                   newdata = .test,
                   type = "response") |> 
      round() |> 
      as.factor(),
    reference = .test$map_winner |> 
      as.factor(),
    positive = "1"
  )
}
```

## Vytvoření modelů, tabulek a statistik
```{r players.models}
players.models <- list()
players.matrixes <- list()
players.split <- list()

library(rsample)

for (m in maps) {
  set.seed(48754)
  
  model.data <- data |> 
    filter(map == m)
  
  split <- initial_split(model.data, prop = 0.8)
  
  players.split[[m]] <- split
  
  model <- get_player_model(.data = training(split))
  
  players.models[[m]] <- model
  players.matrixes[[m]] <-
    get_matrix_for_player_model(.model = model,
                                .test = testing(split))
}

```

### Uložení modelů a tabulek
```{r players.save, options}
for (map in maps) {
  save_bc_model(
    .model = players.models[[map]],
    .file = sprintf("player_model_%s.tex",
                    map),
    .cap = sprintf("Model pro jednotlivé hráče na mapě %s",
                   map))
  
  save_bc_matrix(
    .matrix = players.matrixes[[map]]$table,
    .file = sprintf("player_matice_%s.tex",
                    map),
    .cap = sprintf("Matice záměn pro jednotlivé hráče na mapě %s",
                   map))

  save_bc_matrix_output(
    .object = players.matrixes[[map]],
    .file = sprintf("player_stats_%s.tex",
                    map),
    .cap = sprintf("Statistiky pro jednotlivé hráče na mapě %s",
                               map))
}
```

## Mirage

### Optimalizace
```{r mirage_pro_hrace_opt.tex}
players.models$Mirage <- 
  get_player_model(.data = training(players.split$Mirage),
                   .x = "kills + assists + deaths + fkdiff + starting_ct"
                   )

players.matrixes$Mirage <- 
  get_matrix_for_player_model(.model = players.models$Mirage,
                              .test = testing(players.split$Mirage))

### Znovuuložení
save_bc_model(.model = players.models$Mirage,
              .file = "player_model_Mirage_opt.tex",
              .cap = "Optimální logistický model pro hráče pro mapu Mirage")

save_bc_matrix(
  .matrix = players.matrixes$Mirage$table,
  .file = "player_matice_Mirage_opt.tex",
  .cap = "Matice záměn pro mapu Mirage"
)

save_bc_matrix_output(
  .object = players.matrixes$Mirage,
  .file = "player_stats_Mirage_opt.tex",
  .cap = "Statistiky pro mapu Mirage z matice záměn"
)
```


## Vertigo
```{r vertigo_pro_hrace.tex}
save_bc_model(.model = players.models$Vertigo,
              .file = "vertigo_pro_hrace.tex",
              .cap = "Logistický model pro hráče pro mapu Vertigo")
```

### Optimalizace
```{r vertigo_pro_hrace_opt.tex}
players.models$Vertigo <- 
  get_player_model(.data = training(players.split$Vertigo),
                   .x = "kills + assists + deaths"
                   )

players.matrixes$Vertigo <- 
  get_matrix_for_player_model(.model = players.models$Vertigo,
                              .test = testing(players.split$Vertigo))
### Znovuuložení
### 
save_bc_model(.model = players.models$Vertigo,
              .file = "player_model_Vertigo_opt.tex",
              .cap = "Optimální logistický model pro hráče pro mapu Vertigo")

save_bc_matrix(
  .matrix = players.matrixes$Vertigo$table,
  .file = "player_matice_Vertigo_opt.tex",
  .cap = "Matice záměn pro mapu Vertigo"
)

save_bc_matrix_output(
  .object = players.matrixes$Vertigo,
  .file = "player_stats_Vertigo_opt.tex",
  .cap = "Statistiky pro mapu Vertigo z matice záměn"
)
```