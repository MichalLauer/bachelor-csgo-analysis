---
title: "Analýza dat pro Bakalářskou práci"
author: "Michal Lauer"
date: '2022-04-10'
output:
  html_document:
    css: style.css
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    df_print: paged
    theme: cosmo
    highlight: haddock
editor_options: 
  chunk_output_type: console
---
# Funkce a globální nastavení

## Nastavení
```{r setup, message=F}
knitr::opts_chunk$set(message = F)

options("OutDec" = ",")
options("xtable.include.rownames" = F)
options("xtable.table.placement" = "H")
options("xtable.caption.placement" = "top")
options("xtable.format.args" = list(decimal.mark = ","))
options("digits" = 4)
```

## Knihovny
```{r libraries}
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(runner)
library(ggplot2)
library(GGally)
library(kableExtra)
library(knitr)
library(caret)
library(broom)
library(xtable)
library(rsample)
library(paletteer)

theme_set(theme_minimal() +
            theme(
              plot.caption = element_text(face = "italic")
            ))
```

## Vygenerování pomocních grafů
```{r grafy.Rmd, include=F}
rmarkdown::render("grafy.Rmd",
                  quiet = T)
```

## globální proměnná maps
```{r maps}
maps <- c(
  "Dust2", "Inferno", "Vertigo", "Overpass", "Nuke", "Mirage",
  "Train", "Cache", "Cobblestone"
)
```

## Ukládání pro bakalářskou ráci
```{r bc, file="R/_GLOBAL.R"}
```

## funkce clear_player_map
```{r clear_player_map}
clear_player_map <- function(tbl, map) {
  m_ <- sprintf("m%i_", map)
  tbl |>
    select(match_id, player_id, team,
           # Vybrání mapy a statisik podle pro i-tou mapu
           map = sprintf("map_%i", map),
           matches(sprintf("^m%i_", map))
    ) |>
    # Získání pouze agregovanýc statistik za obě strany
    # e.g. vyloučení m1_kills_ct, m1_kills_t a ponechání pouze m1_kills
    select(!matches("_c?t$")) |>
    drop_na(map) |>
    # Sjednocení názvů, e.g. m1_kills -> kills
    rename_with(
      .cols = starts_with(m_),
      .fn = ~ str_remove_all(.x, m_)
    ) |>
    # Odstranění sloupečků, které nejsou kompletní
    # kvůli historii vývoje cs:go a hltv.org
    select(-c(kddiff, flash_assists, kast, adr)) |>
    # konverze HS na relativní jednotky
    mutate(hs = ifelse(kills == 0, 0, hs / kills))
}
```

## funkce clear_results_team
```{r clear_results_team}
clear_results_team <- function(.tbl, i) {
  .tbl |>
    select(
      date, match_id, team = matches(sprintf("team_%i", i)),
      map, map_winner, starting_ct, 
      team_rank = matches(sprintf("rank_%i", i))
    ) |>
    filter(map %in% maps) |>
    mutate(
      map_winner = as.numeric(map_winner == i),
      starting_ct = as.numeric(starting_ct == i)
    )
}
```

## funkce geom_mean
```{r geom_mean}
geom_mean <- function(x) {
  exp(sum(log(x)) / length(x))
}
```

## funkce save_bc_code
```{r save_bc_code, file="R/save_bc_code.R"}
```

## funkce save_bc_picture
```{r save_bc_picture, file="R/save_bc_picture.R"}
```

# Datový soubor players.csv

## Nahrání dat
```{r }
players.raw <- read_csv("data/players.csv", show_col_types = F)

sprintf("%s proměnných a %s pozorování",
        ncol(players.raw),
        prettyNum(nrow(players.raw), big.mark = " ")
)
```

## Čištění dat
```{r }
players <-
  # Získání charakteristik pro první mapu
  clear_player_map(players.raw, 1) |>
  # Získání charakteristik pro druhou mapu
  rbind(clear_player_map(players.raw, 2)) |>
  # Získání charakteristik pro třetí mapu
  rbind(clear_player_map(players.raw, 3)) |>
  filter(map %in% maps) |>
  drop_na() |> 
  # Odstranění map, kde není právě pět hráčů
  group_by(match_id, team, map) |> 
  filter(n() == 5) |> 
  ungroup() |> 
  mutate(
    match_id = as.integer(match_id),
    player_id = as.integer(player_id),
    kills = as.integer(kills),
    assists = as.integer(assists),
    deaths = as.integer(deaths),
    fkdiff = as.integer(fkdiff)
  )

sprintf("%s proměnných a %s pozorování",
        ncol(players),
        prettyNum(nrow(players), big.mark = " ")
)
```

## Uložení LaTeX tabulky
```{r }
set.seed(12345)
players |> 
  slice_sample(n = 6) |> 
  save_bc_table(
    .tibble = _,
    .file = "players_csv_transformovano.tex",
    .cap = "Záznam z transformovaného datového souboru players.csv",
    .lab = NA,
    .scale = 0.90
  )
```

# Datový soubor results.csv

## Nahrání dat
```{r }
results.raw <- read_csv("data/results.csv", show_col_types = F)

sprintf("%s proměnných a %s pozorování",
        ncol(results.raw),
        prettyNum(nrow(results.raw), big.mark = " ")
)
```

## Čištění dat
```{r }
results <- results.raw |> 
  select(date, team_1, team_2,
         map = `_map`, map_winner,
         starting_ct, rank_1, rank_2, match_id) |> 
  # Smazání záznamu ke tým hrál sám proti sobě
  # Chybná extrakce dat
  filter(match_id != 2314674)

results <-  
  clear_results_team(.tbl = results, 1) |>
  rbind(clear_results_team(.tbl = results, 2)) |> 
  mutate(
    match_id = as.integer(match_id),
    map_winner = as.integer(map_winner),
    starting_ct = as.integer(starting_ct),
    team_rank = as.integer(team_rank)
  ) |> 
  mutate(team = ifelse(team == "?", "Astralis", team))

sprintf("%s proměnných a %s pozorování",
        ncol(results),
        prettyNum(nrow(results), big.mark = " ")
)
```

## Uložení LaTeX tabulky
```{r }
set.seed(9574)
results |> 
  slice_sample(n = 6) |> 
  save_bc_table(
    .tibble = _,
    .file = "results_csv_transformovano.tex",
    .cap = "Příklad záznamu z transformovaného datového souboru results.csv",
    .lab = NA,
    .scale = 1
  )
```

# Spojený datový soubor

## Spojení dat
```{r }
data <- results |> 
  inner_join(players,
             by = c("match_id", "team", "map"))
```

## Uložení LaTeX tabulky
```{r }
set.seed(9574)
data |> 
  slice_sample(n = 6) |> 
  save_bc_table(
    .tibble = _,
    .file = "data_spojena.tex",
    .cap = "Příklad záznamu z transformovaného datového souboru results.csv",
    .lab = NA,
    .scale = 1
  )
```

# Agregovaný datový soubor

## Agregace
```{r }
data.aggregated <- data |>
  group_by(match_id, map, team) |> 
  summarise(
    mean_kills = mean(kills),
    mean_assists = mean(assists),
    mean_deaths = mean(deaths),
    mean_hs = geom_mean(hs),
    mean_fkdiff = mean(fkdiff),
    map_winner = mean(map_winner),
    starting_ct = mean(starting_ct),
    team_rank = mean(team_rank),
    .groups = "drop" 
  )
```

## Uložení LaTeX tabulky
```{r }
set.seed(6587)
data.aggregated |> 
  slice_sample(n = 6) |> 
  save_bc_table(
    .tibble = _,
    .file = "data_agregovana.tex",
    .cap = "Agregovaná data pro týmy za zápas a mapu",
    .lab = NA,
    .scale = 0.5
  )
```

# Průzkumová analýza dat

## Kvantitativní proměnné
```{r }
data |> 
  select(kills, assists, deaths, hs, fkdiff, rating, team_rank) |> 
  ggcorr(hjust = 0.8, size = 4, label = T) +
  labs(
    title = "Korelační matice kvantitativních prediktorů",
    caption = "Spojený datový soubor"
  )

save_bc_picture(.graph = last_plot(),
                .file = "prediktory_corr_matice.png")
```

## Histogram proměnných
```{r }
data.plot <- data.aggregated |> 
  semi_join(
    data.aggregated |> 
      group_by(team) |>
      filter(n() > 100) |> 
      summarise(mtr = mean(team_rank)) |> 
      slice_min(order_by = mtr, n = 10),
    by = "team"
  ) |> 
  group_by(team) |> 
  summarise(mmw = mean(map_winner)) |> 
  arrange(desc(mmw))

ggplot(data = data.plot,
       aes(x = reorder(team, mmw), y = mmw, fill = team)) +
  geom_col(show.legend = F) +
  geom_text(data = filter(data.plot, mmw > 0.6),
            aes(label = paste0(round(mmw * 100, 2), " %"),
                y = mmw + 0.08)) +
  scale_fill_manual(values = paletteer_d("basetheme::deepblue")) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 0.8)) +
  coord_flip() +
  labs(
    title = "Porovnání míry výhry pro nejlepších 10 týmů",
    subtitle = "Pouze pro týmy s alespoň 100 zápasy\nOsa x je omezená na interval <0; 0,8>",
    x = "Tým",
    y = "Míra výhry",
    caption = "Agregovaný datový soubor"
  )

save_bc_picture(.graph = last_plot(),
                .file = "mira_vyhry_tymu.png")
```

## Winrate za CT
```{r }
data |>
  mutate(cat = ifelse(!team %in% c("Astralis", "Sprout"),
                      "Všechny záznamy",
                      paste0("Tým ", team)),
         cat = factor(cat,
                      levels = c("Všechny záznamy",
                                 "Tým Astralis",
                                 "Tým Sprout"))) |> 
  group_by(cat, map) |> 
  filter(map_winner == 1) |> 
  summarise(ct_won = mean(starting_ct),
            .groups = "drop") |> 
  ggplot(aes(x = map, y = ct_won, fill = map)) +
  facet_wrap(vars(cat), ncol = 1, scales = "free_x") +
  geom_col(show.legend = F, color = "black") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  theme(
    panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill = "grey", color = "black")
  ) +
  labs(
    title = "Procento vyhraných zápasu, pokud tým začal\nna mapě za Counter-Terroristy",
    x = "Mapa",
    y = "Procento vyhraných zápasů",
    caption = "Spojení souboru players.csv a results.csv",
    fill = "Tým"
  )

save_bc_picture(.graph = last_plot(),
                .file = "sloupce_podle_strany.png")
```

# Modely pro hráče - Mirage


## Optimalizovaný model
```{r }
set.seed(547)
mirage.data <- data |> 
  filter(map == "Mirage")

mirage.split <- initial_split(mirage.data, prop = 0.8)


mirage.model <- glm(
  formula = map_winner ~ kills + assists + deaths + hs +
    fkdiff + starting_ct,
  data = training(mirage.split),
  family = binomial
)
```

### Uložení LaTeX tabulky
```{r }
save_bc_model(
  .model = mirage.model,
  .file = "Mirage_model.tex",
  .cap = "Výstup z programu R pro logistický model na mapě Mirage",
  .lab = NA
)
```

## Matice záměn
```{r label, options}
mirage.matrix <- 
  confusionMatrix(
    data = predict(object = mirage.model,
                   newdata = testing(mirage.split),
                   type = "response") |> 
      round() |> 
      as.factor(),
    reference = testing(mirage.split)$map_winner |> 
      as.factor(),
    positive = "1"
  )

```

### Uložení LaTeX tabulky
```{r }
save_bc_matrix(
  .table = mirage.matrix$table,
  .file = "Mirage_matice.tex",
  .cap = "Vybrané statistiky z matice záměn pro mapu Mirage",
  .lab = NA
)

save_bc_matrix_output(
  .matrix = mirage.matrix,
  .file = "Mirage_stats.tex",
  .cap = "Statistiky z matice záměn pro mapu Mirage",
  .lab = NA
)

prettyNum(mirage.matrix$table[1, 1],
          big.mark = " ")
round(mirage.matrix$byClass["Specificity"] * 100, 2)
prettyNum(mirage.matrix$table[2, 2],
          big.mark = " ")
round(mirage.matrix$byClass["Sensitivity"] * 100, 2)
prettyNum(
  mirage.matrix$table[1, 1] + mirage.matrix$table[2, 2],
  big.mark = " ")
round(mirage.matrix$overall["Accuracy"] * 100, 2)

```

# Modely pro hráče - Vertigo

## Neotimalizovaný model
```{r }
set.seed(547)
vertigo.data <- data |> 
  filter(map == "Vertigo")

vertigo.split <- initial_split(vertigo.data, prop = 0.8)


vertigo.model <- glm(
  formula = map_winner ~ kills + assists + deaths + hs +
    fkdiff + starting_ct,
  data = training(vertigo.split),
  family = binomial
)
```

### Uložení LaTeX tabulky
```{r }
save_bc_model(
  .model = vertigo.model,
  .file = "Vertigo_model.tex",
  .cap = "Výstup z programu R pro logistický model na mapě Vertigo",
  .lab = NA
)
```

## Otimalizovaný model
```{r }
set.seed(547)
vertigo.data <- data |> 
  filter(map == "Vertigo")

vertigo.split <- initial_split(vertigo.data, prop = 0.8)

vertigo.model <- glm(
  formula = map_winner ~ kills + assists + deaths,
  data = training(vertigo.split),
  family = binomial
)
```

### Uložení LaTeX tabulky
```{r }
save_bc_model(
  .model = vertigo.model,
  .file = "Vertigo_model_opt.tex",
  .cap = "Výstup z programu R pro optimalizovaný logistický model na mapě Vertigo",
  .lab = NA
)
```


## Matice záměn
```{r label, options}
vertigo.matrix <- 
  confusionMatrix(
    data = predict(object = vertigo.model,
                   newdata = testing(vertigo.split),
                   type = "response") |> 
      round() |> 
      as.factor(),
    reference = testing(vertigo.split)$map_winner |> 
      as.factor(),
    positive = "1"
  )

```

### Uložení LaTeX tabulky
```{r }
save_bc_matrix(
  .table = vertigo.matrix$table,
  .file = "Vertigo_matice_opt.tex",
  .cap = "Vybrané statistiky z matice záměn pro mapu Vertigo",
  .lab = NA
)

save_bc_matrix_output(
  .matrix = vertigo.matrix,
  .file = "Vertigo_stats_opt.tex",
  .cap = "Statistiky z matice záměn pro mapu Vertigo",
  .lab = NA
)

prettyNum(vertigo.matrix$table[1, 1],
          big.mark = " ")
round(vertigo.matrix$byClass["Specificity"] * 100, 2)
prettyNum(vertigo.matrix$table[2, 2],
          vertigo.matrix = " ")
round(vertigo.matrix$byClass["Sensitivity"] * 100, 2)
prettyNum(
  vertigo.matrix$table[1, 1] + vertigo.matrix$table[2, 2],
  big.mark = " ")
round(vertigo.matrix$overall["Accuracy"] * 100, 2)

```

# Porovnání statistik obou modelů
```{r }
m1 <-
  bind_rows(
    tibble(
      statistika = names(mirage.matrix$overall),
      mapa_mirage = mirage.matrix$overall
    ),
    tibble(
      statistika = names(mirage.matrix$byClass),
      mapa_mirage = mirage.matrix$byClass
    )
  ) |>
  filter(statistika %in% c("Accuracy", "Sensitivity", "Specificity")) |> 
  mutate(statistika = c("Přesnost", "Senzitivita", "Specificita"))

m2 <-
  bind_rows(
    tibble(
      statistika = names(vertigo.matrix$overall),
      mapa_vertigo = vertigo.matrix$overall
    ),
    tibble(
      statistika = names(vertigo.matrix$byClass),
      mapa_vertigo = vertigo.matrix$byClass
    )
  ) |>
  filter(statistika %in% c("Accuracy", "Sensitivity", "Specificity")) |> 
  mutate(statistika = c("Přesnost", "Senzitivita", "Specificita"))

m12 <- 
  cbind(
    m1,
    m2 |> select(-statistika)
  )

save_bc_table(
  .tibble = m12,
  .file = "Mirage_Vertigo_porovnani.text",
  .cap = "Porovnání statistik pro mapu Mirage a Vertigo",
  .lab = NA
)
```

# Uložení ostatních map
```{r }
set.seed(962147)
for (.map in setdiff(maps, c("Mirage", "Vertigo"))) {

  .data <- data |> 
    filter(map == .map)
  
  .split <- initial_split(.d, prop = 0.8)
  
  .model <- glm(
    formula = map_winner ~ kills + assists + deaths + hs +
      fkdiff + starting_ct,
    data = training(.split),
    family = binomial
  )
  
  save_bc_model(
    .model = .model,
    .file = sprintf("%s_model.tex",
                    .map),
    .cap = sprintf(
      "Výstup z programu R pro logistický model na mapě %s",
      .map),
    .lab = NA
  )
  
  .matrix <- 
    confusionMatrix(
      data = predict(object = .model,
                     newdata = testing(.split),
                     type = "response") |> 
        round() |> 
        as.factor(),
      reference = testing(.split)$map_winner |> 
        as.factor(),
      positive = "1"
    )
  
  save_bc_matrix(
    .table = .matrix$table,
    .file = sprintf(
      "%s_matice.tex",
      .map),
    .cap = sprintf(
      "Vybrané statistiky z matice záměn pro mapu %s",
      .map),
    .lab = NA
  )
  
  save_bc_matrix_output(
    .matrix = .matrix,
    .file = sprintf("%s_stats.tex",
                    .map),
    .cap = sprintf("Statistiky z matice záměn pro mapu %s",
                   .map),
    .lab = NA
  )
}

```

































# -------------------------------------------------






```{r }
get_player_model <- function(.data,
                             .y = "map_winner",
                             .x = "kills + assists + deaths + hs + fkdiff + starting_ct"
) {
  
  .formula = as.formula(sprintf("%s ~ %s",
                                .y,
                                .x))
  
  glm(formula = .formula,
      data = .data,
      family = binomial)
}

get_conf_matrix <- function(.model, .test) {
  confusionMatrix(
    data = predict(object = .model,
                   newdata = .test,
                   type = "response") |> 
      round() |> 
      as.factor(),
    reference = .test$map_winner |> 
      as.factor(),
    positive = "1"
  )
}

get_player_data <- function(.data, .map) {
  .data |> 
    filter(map == .map)
}
```

## Vytvoření modelů, tabulek a statistik
```{r }
players.models <- list()
players.matrixes <- list()
players.split <- list()

for (m in maps) {
  set.seed(48754)
  
  model.data <- get_player_data(
    .data = data,
    .map = m
  )
  
  split <- initial_split(model.data, prop = 0.8)
  players.split[[m]] <- split
  
  model <- get_player_model(.data = training(split))
  
  players.models[[m]] <- model
  players.matrixes[[m]] <-
    get_conf_matrix(.model = model,
                    .test = testing(split))
}

data
```

## Uložení modelů a tabulek
```{r }
save_player_map <- function(.map, .use_cap) {
  save_bc_model(
    .model = players.models[[.map]],
    .file = sprintf("player_model_%s.tex",
                    .map),
    .cap = sprintf("Model pro jednotlivé hráče na mapě %s",
                   .map),
    .use_cap = .use_cap)
  
  save_bc_matrix(
    .matrix = players.matrixes[[.map]]$table,
    .file = sprintf("player_matice_%s.tex",
                    .map),
    .cap = sprintf("Matice záměn pro jednotlivé hráče na mapě %s",
                   .map),
    .use_cap = .use_cap)
  
  save_bc_matrix_output(
    .object = players.matrixes[[.map]],
    .file = sprintf("player_stats_%s.tex",
                    .map),
    .cap = sprintf("Statistiky pro jednotlivé hráče na mapě %s",
                   .map),
    .use_cap = .use_cap)
}

for (map in maps) {
  save_player_map(
    .map = map,
    .use_cap = F
  )  
}
```

## Mirage

### Uložení neoptimálního modelu
```{r }
save_player_map(
  .map = "Mirage",
  .use_cap = T
)
```

### Optimalizace
```{r }
players.models$Mirage <- 
  get_player_model(.data = training(players.split$Mirage),
                   .x = "kills + assists + deaths + fkdiff + starting_ct"
  )

players.matrixes$Mirage <- 
  get_conf_matrix(.model = players.models$Mirage,
                  .test = testing(players.split$Mirage))
```

### Uložení optimálního modelu
```{r }
save_bc_model(.model = players.models$Mirage,
              .file = "player_model_Mirage_opt.tex",
              .cap = "Optimální logistický model pro hráče pro mapu Mirage")

save_bc_matrix(
  .matrix = players.matrixes$Mirage$table,
  .file = "player_matice_Mirage_opt.tex",
  .cap = "Optimální matice záměn pro mapu Mirage"
)

save_bc_matrix_output(
  .object = players.matrixes$Mirage,
  .file = "player_stats_Mirage_opt.tex",
  .cap = "Optimální statistiky pro mapu Mirage z matice záměn"
)
```

## Vertigo
```{r }
save_bc_model(.model = players.models$Vertigo,
              .file = "vertigo_pro_hrace.tex",
              .cap = "Logistický model pro hráče pro mapu Vertigo")
```

### Uložení neoptimánlího modelu
```{r }
save_player_map(
  .map = "Vertigo",
  .use_cap = T
)
```

### Optimalizace
```{r }
players.models$Vertigo <- 
  get_player_model(.data = training(players.split$Vertigo),
                   .x = "kills + assists + deaths"
  )

players.matrixes$Vertigo <- 
  get_conf_matrix(.model = players.models$Vertigo,
                  .test = testing(players.split$Vertigo))
```

### Uložení optimálního modelu
```{r }
save_bc_model(.model = players.models$Vertigo,
              .file = "player_model_Vertigo_opt.tex",
              .cap = "Optimální logistický model pro hráče pro mapu Vertigo")

save_bc_matrix(
  .matrix = players.matrixes$Vertigo$table,
  .file = "player_matice_Vertigo_opt.tex",
  .cap = "Optimální matice záměn pro mapu Vertigo"
)

save_bc_matrix_output(
  .object = players.matrixes$Vertigo,
  .file = "player_stats_Vertigo_opt.tex",
  .cap = "Optimální statistiky pro mapu Vertigo z matice záměn"
)
```

# Modely pro tým
```{r }
get_team_model <- function(.data,
                           .y = "map_winner",
                           .x = "") {
  .formula = as.formula(sprintf("%s ~ %s",
                                .y,
                                .x))
  
  glm(formula = .formula,
      data = .data,
      family = "binomial")
}

get_team_data <- function(.data, .filter) {
  .data |> 
    filter(str_detect(team, .filter)) |> 
    group_by(match_id, map, team) |> 
    filter(n() %% 5 == 0) |> 
    summarise(
      mean_kills = mean(kills),
      mean_assists = mean(assists),
      mean_deaths = mean(deaths),
      mean_hs = geom_mean(hs),
      mean_fkdiff = mean(fkdiff),
      map_winner = mean(map_winner),
      starting_ct = mean(starting_ct),
      team_rank = mean(team_rank),
      .groups = "drop" 
    ) |> 
    # Kontrola, že všichni hráčí mají zadaný stejný výsledek
    filter(
      map_winner %in% c(0, 1),
      starting_ct %in% c(0, 1)
    )
}

get_team_data(data, ".") |> glimpse()

```

## Vytvoření modelů, tabulek a statistik
```{r }
teams <- c("All", "Astralis", "Sprout")
teams.models <- list()
teams.matrixes <- list()
teams.split <- list()

for (t in teams) {
  set.seed(7458)
  
  filter <- ifelse(t == "All", ".*", t)
  
  model.data <- get_team_data(
    .data = data,
    .filter = filter
  )
  
  split <- initial_split(model.data, prop = 0.8,
                         strata = map)
  
  teams.split[[t]] <- split
  
  model <- get_team_model(
    .data = training(split),
    .x = paste0("mean_kills + mean_assists + mean_deaths + mean_hs +",
                "mean_fkdiff + team_rank + map:starting_ct")
  )
  
  summary(model)
  
  teams.models[[t]] <- model
  teams.matrixes[[t]] <-
    get_conf_matrix(.model = model,
                    .test = testing(split))
}
```

## Uložení modelů a tabulek
```{r }
### Uložení agregované tabulky
set.seed(587)
teams.models$All$data |> 
  slice_sample(n = 6) |> 
  save_bc_code(
    .tibble = _,
    .file = "data_agregovana.tex",
    .cap = "Agregovaná tabulka pro predikcy výhry týmu",
    .lab = "tab:data_agregovana",
    .scale = 0.5
  )

### Uložení statistik
for (t in teams) {
  cap <- ifelse(t == "All",
                "pro všechny týmy",
                sprintf("pro tým %s", t))
  
  save_bc_model(
    .model = teams.models[[t]],
    .file = sprintf("team_model_%s.tex",
                    t),
    .cap = sprintf("Model %s",
                   cap)
  )
  
  save_bc_matrix(
    .matrix = teams.matrixes[[t]]$table,
    .file = sprintf("team_matice_%s.tex",
                    t),
    .cap = sprintf("Matice záměn %s",
                   cap))
  
  save_bc_matrix_output(
    .object = teams.matrixes[[t]],
    .file = sprintf("team_stats_%s.tex",
                    t),
    .cap = sprintf("Statistiky %s",
                   cap))
}
```
## Celkový model

## tým Astralis

### Optimalizace
```{r }
teams.models$Astralis <- 
  get_team_model(
    .data = training(teams.split$Astralis),
    .x = "mean_kills + mean_deaths"
  )

teams.matrixes$Astralis <- 
  get_conf_matrix(
    .model = teams.models$Astralis,
    .test = testing(teams.split$Astralis))

### Uložení statistik

t <- "Astralis"

cap <- ifelse(t == "All",
              "pro všechny týmy",
              sprintf("pro tým %s", t))

save_bc_model(
  .model = teams.models[[t]],
  .file = sprintf("team_model_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální Model %s",
                 cap))

save_bc_matrix(
  .matrix = teams.matrixes[[t]]$table,
  .file = sprintf("team_matice_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální matice záměn %s",
                 cap))

save_bc_matrix_output(
  .object = teams.matrixes[[t]],
  .file = sprintf("team_stats_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální statistiky %s",
                 cap))

```

## Tým Sprout

## Optimalizace
```{r }
teams.models$Sprout <- 
  get_team_model(
    .data = training(teams.split$Sprout),
    .x = "mean_kills + mean_deaths"
  )

teams.matrixes$Sprout <- 
  get_conf_matrix(
    .model = teams.models$Sprout,
    .test = testing(teams.split$Sprout))

### Uložení statistik

t <- "Sprout"

cap <- ifelse(t == "All",
              "pro všechny týmy",
              sprintf("pro tým %s", t))

save_bc_model(
  .model = teams.models[[t]],
  .file = sprintf("team_model_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální Model %s",
                 cap))

save_bc_matrix(
  .matrix = teams.matrixes[[t]]$table,
  .file = sprintf("team_matice_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální matice záměn %s",
                 cap))

save_bc_matrix_output(
  .object = teams.matrixes[[t]],
  .file = sprintf("team_stats_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální statistiky %s",
                 cap))
```