---
title: "Analýza dat pro Bakalářskou práci"
author: "Michal Lauer"
date: '2022-04-10'
output:
  html_document:
    css: style.css
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    df_print: paged
    theme: cosmo
    highlight: haddock
editor_options: 
  chunk_output_type: console
---
# Funkce a globální nastavení

## Nastavení
```{r global-options, message=F}
knitr::opts_chunk$set(message = F)
options(OutDec = ",")
```

## Knihovny
```{r libraries}
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(runner)
library(ggplot2)
library(GGally)
library(kableExtra)
library(knitr)
library(caret)
library(broom)
library(xtable)
library(rsample)

theme_set(theme_minimal() +
            theme(
              plot.caption = element_text(face = "italic")
            ))
```

## Vygenerování pomocních grafů
```{r grafy.Rmd, include=F}
rmarkdown::render("grafy.Rmd",
                  quiet = T)
```

## globální proměnná maps
```{r maps}
maps <- c(
  "Dust2", "Inferno", "Vertigo", "Overpass", "Nuke", "Mirage",
  "Train", "Cache", "Cobblestone"
)
```

## Ukládání pro bakalářskou ráci
```{r bc, file="R/_GLOBAL.R"}
```

## funkce clear_player_map
```{r clear_player_map}
clear_player_map <- function(tbl, map) {
  m_ <- sprintf("m%i_", map)
  tbl |>
    select(match_id, player_id, team,
           # Vybrání mapy a statisik podle pro i-tou mapu
           map = sprintf("map_%i", map),
           matches(sprintf("^m%i_", map))
    ) |>
    # Získání pouze agregovanýc statistik za obě strany
    # e.g. vyloučení m1_kills_ct, m1_kills_t a ponechání pouze m1_kills
    select(!matches("_c?t$")) |>
    drop_na(map) |>
    # Sjednocení názvů, e.g. m1_kills -> kills
    rename_with(
      .cols = starts_with(m_),
      .fn = ~ str_remove_all(.x, m_)
    ) |>
    # Odstranění sloupečků, které nejsou kompletní
    # kvůli historii vývoje cs:go a hltv.org
    select(-c(kddiff, flash_assists, kast, adr)) |>
    # konverze HS na relativní jednotky
    mutate(hs = ifelse(kills == 0, 0, hs / kills))
}
```

## funkce clear_results_team
```{r clear_results_team}
clear_results_team <- function(tbl, i) {
  tbl |>
    select(
      date, match_id, team = matches(sprintf("team_%i", i)),
      map, map_winner, starting_ct, 
      team_rank = matches(sprintf("rank_%i", i))
    ) |>
    filter(map %in% maps) |>
    mutate(
      map_winner = as.numeric(map_winner == i),
      starting_ct = as.numeric(starting_ct == i)
    )
}
```

## funkce geom_mean
```{r geom_mean}
geom_mean <- function(x) {
  exp(sum(log(x)) / length(x))
}
```

## funkce save_bc_code
```{r save_bc_code, file="R/save_bc_code.R"}
```

## funkce save_bc_picture
```{r save_bc_picture, file="R/save_bc_picture.R"}
```

# Cíl analýzy

# Nahrání dat

## economy.csv

## picks.csv

## players.csv

```{r }
players.raw <- read_csv("data/players.csv", show_col_types = F)

players.raw |>
  slice_sample(n = 10) |>
  print()
```


```{r }
players <- clear_player_map(players.raw, 1) |>
  rbind(clear_player_map(players.raw, 2)) |>
  rbind(clear_player_map(players.raw, 3)) |>
  filter(map %in% maps) |>
  drop_na() |> 
  group_by(match_id) |>
  # Odstranění zápasů, kde není počet záznamů rovný 
  # 10 (Bo1), 20 (Bo2) nebo 30 (Bo3)
  filter(n() %% 10 == 0) |>
  ungroup() |> 
  mutate(
    match_id = as.integer(match_id),
    player_id = as.integer(player_id),
    kills = as.integer(kills),
    assists = as.integer(assists),
    deaths = as.integer(deaths),
    fkdiff = as.integer(fkdiff)
  )
```


```{r }
set.seed(12345)
r <- players |> 
  slice_sample(n = 6)
save_bc_code(
  .tibble = r,
  .file = "players_csv_transformovano.tex",
  .cap = "Záznam z transformovaného datového souboru players.csv",
  .lab = "tab:players_csv_transformovano",
  .scale = 0.90)
r
```



## results.csv
```{r }
results.raw <- read_csv("data/results.csv",
                        show_col_types = F,
                        col_select = c(date, team_1, team_2,
                                       map = "_map", map_winner,
                                       starting_ct, rank_1, rank_2, match_id
                        )
) |>
  # Smazání záznamu ke tým hrál sám proti sobě
  # Chybná extrakce dat
  filter(match_id != 2314674)
```

```{r ,cache=TRUE}
results <- clear_results_team(results.raw, 1) |>
  rbind(clear_results_team(results.raw, 2)) |> 
  mutate(
    match_id = as.integer(match_id),
    map_winner = as.integer(map_winner),
    starting_ct = as.integer(starting_ct),
    team_rank = as.integer(team_rank)
  )

set.seed(9574)
r <- results |> 
  slice_sample(n = 6)

save_bc_code(
  .tibble = r,
  .file = "results_csv_transformovano.tex",
  .cap = "Příklad záznamu z transformovaného datového souboru results.csv",
  .lab = "tab:results_csv_transformovano",
  .scale = 1
)
r
```

# Průzkumová analýza dat
```{r }
data <- players |> 
  inner_join(results,
             by = c("match_id", "map", "team"))

set.seed(7845)
r <- data |> 
  slice_sample(n = 6)
save_bc_code(
  .tibble = r,
  .file = "data_transformovano.tex",
  .cap = "Datový soubor pro logistické modely",
  .lab = "tab:data_transformovano",
  .scale = 0.6)
r
```

## Kvantitativní proměnné
```{r }
g <- data |> 
  select(kills, assists, deaths, hs, fkdiff, rating,
         team_rank) |> 
  ggcorr(hjust = 0.8, size = 4, label = T) +
  labs(
    title = "Korelační matice kvantitativních prediktorů",
    caption = "Spojení souboru players.csv a results.csv"
  )

save_bc_picture(.graph = g,
                .file = "prediktory_corr_matice.png")
g
```

## Histogram proměnných
```{r }
bin_count <- round(1 + 3.3*log10(nrow(data)/6))
g <- data |>
  pivot_longer(
    cols = c(kills, assists, deaths, hs, fkdiff, rating),
    names_to = "stats",
    values_to = "vals"
  ) |> 
  select(stats, vals) |>
  mutate(bins = 1 + 3.3*log10(n()/6),
         bins = 1) |> 
  ggplot(aes(x = vals, fill = stats)) +
  facet_wrap(vars(stats), ncol = 2, scales = "free") +
  geom_histogram(bins = bin_count, show.legend = F) +
  scale_y_continuous(labels = scales::number) +
  theme(
    axis.title.x = element_blank(),
    strip.background = element_rect(fill = "grey")
  ) +
  labs(
    title = "Rozdělení kvantitativních statistik",
    subtitle = "Osa Y je přizpůsobená každé statistice",
    y = "Absolutní počet",
    caption = "Spojení souboru players.csv a results.csv"
  )

save_bc_picture(.graph = g,
                .file = "histogram_prediktoru.png")
g
```

## Winrate za CT
```{r }
g <- data |>
  mutate(cat = ifelse(!team %in% c("Astralis", "Sprout"),
                      "Všechny záznamy",
                      paste0("Tým ", team)),
         cat = factor(cat,
                      levels = c("Všechny záznamy",
                                 "Tým Astralis",
                                 "Tým Sprout"))) |> 
  group_by(cat, map) |> 
  filter(map_winner == 1) |> 
  summarise(ct_won = mean(starting_ct)) |> 
  ggplot(aes(x = map, y = ct_won, fill = map)) +
  facet_wrap(vars(cat), ncol = 1, scales = "free_x") +
  geom_col(show.legend = F, color = "black") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  theme(
    panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill = "grey", color = "black")
  ) +
  labs(
    title = "Procento vyhraných zápasu, pokud tým začal\nna mapě za Counter-Terroristy",
    x = "Mapa",
    y = "Procento vyhraných zápasů",
    caption = "Spojení souboru players.csv a results.csv",
    fill = "Tým"
  )

save_bc_picture(.graph = g,
                .file = "sloupce_podle_strany.png")
g
```

# Model pro hráče
```{r }
get_player_model <- function(.data,
                             .y = "map_winner",
                             .x = "kills + assists + deaths + hs + fkdiff + starting_ct"
) {
  
  .formula = as.formula(sprintf("%s ~ %s",
                                .y,
                                .x))
  
  glm(formula = .formula,
      data = .data,
      family = binomial)
}

get_conf_matrix <- function(.model, .test) {
  confusionMatrix(
    data = predict(object = .model,
                   newdata = .test,
                   type = "response") |> 
      round() |> 
      as.factor(),
    reference = .test$map_winner |> 
      as.factor(),
    positive = "1"
  )
}

get_player_data <- function(.data, .map) {
  .data |> 
    filter(map == .map)
}
```

## Vytvoření modelů, tabulek a statistik
```{r }
players.models <- list()
players.matrixes <- list()
players.split <- list()

for (m in maps) {
  set.seed(48754)
  
  model.data <- get_player_data(
    .data = data,
    .map = m
  )
  
  split <- initial_split(model.data, prop = 0.8)
  players.split[[m]] <- split
  
  model <- get_player_model(.data = training(split))
  
  players.models[[m]] <- model
  players.matrixes[[m]] <-
    get_conf_matrix(.model = model,
                    .test = testing(split))
}

data
```

## Uložení modelů a tabulek
```{r }
save_player_map <- function(.map, .use_cap) {
  save_bc_model(
    .model = players.models[[.map]],
    .file = sprintf("player_model_%s.tex",
                    .map),
    .cap = sprintf("Model pro jednotlivé hráče na mapě %s",
                   .map),
    .use_cap = .use_cap)
  
  save_bc_matrix(
    .matrix = players.matrixes[[.map]]$table,
    .file = sprintf("player_matice_%s.tex",
                    .map),
    .cap = sprintf("Matice záměn pro jednotlivé hráče na mapě %s",
                   .map),
    .use_cap = .use_cap)
  
  save_bc_matrix_output(
    .object = players.matrixes[[.map]],
    .file = sprintf("player_stats_%s.tex",
                    .map),
    .cap = sprintf("Statistiky pro jednotlivé hráče na mapě %s",
                   .map),
    .use_cap = .use_cap)
}

for (map in maps) {
  save_player_map(
    .map = map,
    .use_cap = F
  )  
}
```

## Mirage

### Uložení neoptimálního modelu
```{r }
save_player_map(
  .map = "Mirage",
  .use_cap = T
)
```

### Optimalizace
```{r }
players.models$Mirage <- 
  get_player_model(.data = training(players.split$Mirage),
                   .x = "kills + assists + deaths + fkdiff + starting_ct"
  )

players.matrixes$Mirage <- 
  get_conf_matrix(.model = players.models$Mirage,
                  .test = testing(players.split$Mirage))
```

### Uložení optimálního modelu
```{r }
save_bc_model(.model = players.models$Mirage,
              .file = "player_model_Mirage_opt.tex",
              .cap = "Optimální logistický model pro hráče pro mapu Mirage")

save_bc_matrix(
  .matrix = players.matrixes$Mirage$table,
  .file = "player_matice_Mirage_opt.tex",
  .cap = "Matice záměn pro mapu Mirage"
)

save_bc_matrix_output(
  .object = players.matrixes$Mirage,
  .file = "player_stats_Mirage_opt.tex",
  .cap = "Statistiky pro mapu Mirage z matice záměn"
)
```

## Vertigo
```{r }
save_bc_model(.model = players.models$Vertigo,
              .file = "vertigo_pro_hrace.tex",
              .cap = "Logistický model pro hráče pro mapu Vertigo")
```

### Uložení neoptimánlího modelu
```{r }
save_player_map(
  .map = "Vertigo",
  .use_cap = T
)
```

### Optimalizace
```{r }
players.models$Vertigo <- 
  get_player_model(.data = training(players.split$Vertigo),
                   .x = "kills + assists + deaths"
  )

players.matrixes$Vertigo <- 
  get_conf_matrix(.model = players.models$Vertigo,
                  .test = testing(players.split$Vertigo))
```

### Uložení optimálního modelu
```{r }
save_bc_model(.model = players.models$Vertigo,
              .file = "player_model_Vertigo_opt.tex",
              .cap = "Optimální logistický model pro hráče pro mapu Vertigo")

save_bc_matrix(
  .matrix = players.matrixes$Vertigo$table,
  .file = "player_matice_Vertigo_opt.tex",
  .cap = "Matice záměn pro mapu Vertigo"
)

save_bc_matrix_output(
  .object = players.matrixes$Vertigo,
  .file = "player_stats_Vertigo_opt.tex",
  .cap = "Statistiky pro mapu Vertigo z matice záměn"
)
```

# Modely pro tým
```{r }
get_team_model <- function(.data,
                           .y = "map_winner",
                           .x = "") {
  .formula = as.formula(sprintf("%s ~ %s",
                                .y,
                                .x))
  
  glm(formula = .formula,
      data = .data,
      family = "binomial")
}

get_team_data <- function(.data, .filter) {
  .data |> 
    filter(str_detect(team, .filter)) |> 
    group_by(match_id, map, team) |> 
    filter(n() %% 5 == 0) |> 
    summarise(
      mean_kills = mean(kills),
      mean_assists = mean(assists),
      mean_deaths = mean(deaths),
      mean_hs = geom_mean(hs),
      mean_fkdiff = mean(fkdiff),
      map_winner = mean(map_winner),
      starting_ct = mean(starting_ct),
      team_rank = mean(team_rank),
      .groups = "drop" 
    ) |> 
    # Kontrola, že všichni hráčí mají zadaný stejný výsledek
    filter(
      map_winner %in% c(0, 1),
      starting_ct %in% c(0, 1)
    )
}
```

## Vytvoření modelů, tabulek a statistik
```{r }
teams <- c("All", "Astralis", "Sprout")
teams.models <- list()
teams.matrixes <- list()
teams.split <- list()

for (t in teams) {
  set.seed(7458)
  
  filter <- ifelse(t == "All", ".*", t)
  
  model.data <- get_team_data(
    .data = data,
    .filter = filter
  )
  
  split <- initial_split(model.data, prop = 0.8,
                         strata = map)
  
  teams.split[[t]] <- split
  
  model <- get_team_model(
    .data = training(split),
    .x = paste0("mean_kills + mean_assists + mean_deaths + mean_hs +",
                "mean_fkdiff + team_rank + map:starting_ct")
  )
  
  summary(model)
  
  teams.models[[t]] <- model
  teams.matrixes[[t]] <-
    get_conf_matrix(.model = model,
                    .test = testing(split))
}
```

## Uložení modelů a tabulek
```{r }
### Uložení agregované tabulky
set.seed(587)
teams.models$All$data |> 
  slice_sample(n = 6) |> 
  save_bc_code(
    .tibble = _,
    .file = "data_agregovana.tex",
    .cap = "Agregovaná tabulka pro predikcy výhry týmu",
    .lab = "tab:data_agregovana",
    .scale = 0.5
  )

### Uložení statistik
for (t in teams) {
  cap <- ifelse(t == "All",
                "pro všechny týmy",
                sprintf("pro tým %s", t))
  
  save_bc_model(
    .model = teams.models[[t]],
    .file = sprintf("team_model_%s.tex",
                    t),
    .cap = sprintf("Model %s",
                   cap)
  )
  
  save_bc_matrix(
    .matrix = teams.matrixes[[t]]$table,
    .file = sprintf("team_matice_%s.tex",
                    t),
    .cap = sprintf("Matice záměn %s",
                   cap))
  
  save_bc_matrix_output(
    .object = teams.matrixes[[t]],
    .file = sprintf("team_stats_%s.tex",
                    t),
    .cap = sprintf("Statistiky %s",
                   cap))
}
```
## Celkový model

## tým Astralis

### Optimalizace
```{r }
teams.models$Astralis <- 
  get_team_model(
    .data = training(teams.split$Astralis),
    .x = "mean_kills + mean_deaths"
  )

teams.matrixes$Astralis <- 
  get_conf_matrix(
    .model = teams.models$Astralis,
    .test = testing(teams.split$Astralis))

### Uložení statistik

t <- "Astralis"

cap <- ifelse(t == "All",
              "pro všechny týmy",
              sprintf("pro tým %s", t))

save_bc_model(
  .model = teams.models[[t]],
  .file = sprintf("team_model_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální Model %s",
                 cap))

save_bc_matrix(
  .matrix = teams.matrixes[[t]]$table,
  .file = sprintf("team_matice_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální matice záměn %s",
                 cap))

save_bc_matrix_output(
  .object = teams.matrixes[[t]],
  .file = sprintf("team_stats_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální statistiky %s",
                 cap))

```

## Tým Sprout

## Optimalizace
```{r }
teams.models$Sprout <- 
  get_team_model(
    .data = training(teams.split$Sprout),
    .x = "mean_kills + mean_deaths"
  )

teams.matrixes$Sprout <- 
  get_conf_matrix(
    .model = teams.models$Sprout,
    .test = testing(teams.split$Sprout))

### Uložení statistik

t <- "Sprout"

cap <- ifelse(t == "All",
              "pro všechny týmy",
              sprintf("pro tým %s", t))

save_bc_model(
  .model = teams.models[[t]],
  .file = sprintf("team_model_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální Model %s",
                 cap))

save_bc_matrix(
  .matrix = teams.matrixes[[t]]$table,
  .file = sprintf("team_matice_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální matice záměn %s",
                 cap))

save_bc_matrix_output(
  .object = teams.matrixes[[t]],
  .file = sprintf("team_stats_%s_opt.tex",
                  t),
  .cap = sprintf("Optimální statistiky %s",
                 cap))
```